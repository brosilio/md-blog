<!DOCTYPE html>
<html lang="en">
  <head>
    <%- include('head') %>
    <link rel="stylesheet" href="/codemirror/lib/codemirror.css">
  </head>
<body>
  <header>
    <%- include('header') %>
    <h2><% if (isNew) { %>new post<% } else { %><a href="/">/post</a>/<%= slug %> &mdash; edit<% } %></h2>
    <hr>
  </header>
  <main>
    <% if (error) { %>
      <p class="form-error"><%= error %></p>
    <% } %>
    <form method="POST" action="<%= formAction %>">

      <% if (isNew) { %>
        <label for="slug">slug</label><br>
        <input type="text" id="slug" name="slug" value="<%= slug %>" pattern="[a-z0-9-]+" placeholder="my-post-slug" required><br><br>
      <% } %>

      <label for="postTitle">title</label><br>
      <input type="text" id="postTitle" name="postTitle" value="<%= postTitle %>"><br><br>

      <label for="tags">tags <span style="color:#666;">(comma-separated)</span></label><br>
      <input type="text" id="tags" name="tags" value="<%= tags %>" placeholder="tag1, tag2"><br><br>

      <label><input type="checkbox" name="draft" value="yes"<% if (draft) { %> checked<% } %>> draft</label><br><br>

      <% if (extraMeta || !isNew) { %>
        <label for="extraMeta">other metadata <span style="color:#666;">(key: value lines)</span></label><br>
        <textarea id="extraMeta" name="extraMeta" rows="4"><%= extraMeta %></textarea><br><br>
      <% } else { %>
        <input type="hidden" name="extraMeta" value="">
      <% } %>

      <hr>

      <label for="content">content</label>
      &nbsp;<a href="#" id="font-increase" class="editor-font-ctrl" title="increase font size">A+</a>
      &nbsp;<a href="#" id="font-decrease" class="editor-font-ctrl" title="decrease font size">a-</a><br>
      <textarea id="content" name="content" rows="25"><%= content %></textarea><br><br>

      <button type="submit"><% if (isNew) { %>create<% } else { %>save<% } %></button>
      &nbsp;<button type="submit" name="action" value="preview" class="btn-secondary"><% if (isNew) { %>create<% } else { %>save<% } %> as draft &amp; preview</button>
      <% if (!isNew && !isTrash) { %>
        &nbsp;<button type="submit" formaction="/admin/post/<%= slug %>/delete" class="btn-danger" onclick="return confirm('Move \u201c<%= slug %>\u201d to trash?')">delete</button>
      <% } %>
      <% if (!isNew) { %>
        &nbsp;<a href="<% if (isTrash) { %>/admin/trash<% } else { %>/post/<%= slug %><% } %>">cancel</a>
      <% } %>
    </form>
  </main>
  <script src="/codemirror/lib/codemirror.js"></script>
  <script src="/codemirror/mode/markdown/markdown.js"></script>
  <script>
    const cm = CodeMirror.fromTextArea(document.getElementById('content'), {
      mode: 'markdown',
      theme: 'blog',
      lineNumbers: true,
      lineWrapping: true,
    });

    const FONT_STEP = 1;
    const FONT_MIN = 8;
    const FONT_MAX = 32;
    const STORAGE_KEY = 'editor-font-size';

    function setFontSize(px) {
      px = Math.min(FONT_MAX, Math.max(FONT_MIN, px));
      cm.getWrapperElement().style.fontSize = px + 'px';
      cm.refresh();
      localStorage.setItem(STORAGE_KEY, px);
    }

    const saved = parseInt(localStorage.getItem(STORAGE_KEY));
    if (saved) setFontSize(saved);

    document.getElementById('font-increase').addEventListener('click', (e) => {
      e.preventDefault();
      const current = parseInt(getComputedStyle(cm.getWrapperElement()).fontSize);
      setFontSize(current + FONT_STEP);
    });

    document.getElementById('font-decrease').addEventListener('click', (e) => {
      e.preventDefault();
      const current = parseInt(getComputedStyle(cm.getWrapperElement()).fontSize);
      setFontSize(current - FONT_STEP);
    });
  </script>
</body>
</html>
