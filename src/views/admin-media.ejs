<!DOCTYPE html>
<html lang="en">
  <head>
    <%- include('head') %>
  </head>
<body>
  <header>
    <%- include('header') %>
    <h2>/admin/media</h2>
    <nav>
      <span><%= username %></span>
      &mdash; <a href="/">home</a>
      &mdash; <a href="/admin/post/new">new post</a>
      &mdash; <a href="/admin/media">media</a>
      &mdash; <a href="/admin/trash">trash</a>
      &mdash; <a href="/logout">logout</a>
    </nav>
    <hr>
  </header>
  <main>
    <% if (error) { %>
      <p class="form-error"><%= error %></p>
    <% } %>
    <% if (uploaded) { %>
      <p class="upload-success">uploaded &mdash; url: <code><%= uploaded.url %></code></p>
    <% } %>

    <form method="POST" action="/admin/media/upload" enctype="multipart/form-data">
      <label for="file">upload file</label><br>
      <input type="file" id="media-file" name="file" accept="image/*,video/*,audio/*,.pdf" required><br><br>
      <div id="convert-row" style="display:none">
        <label for="convert">format</label><br>
        <select id="convert-select" name="convert">
          <option value="leave">leave as-is</option>
          <option value="jpg">convert to jpg</option>
        </select><br><br>
        <div id="quality-row" style="display:none">
          <label for="quality">quality: <span id="quality-label">85</span></label><br>
          <input type="range" id="quality" name="quality" min="1" max="100" value="85"><br><br>
        </div>
      </div>
      <button type="submit">upload</button>
    </form>
    <script>
      const mediaFile = document.getElementById('media-file');
      const convertRow = document.getElementById('convert-row');
      const convertSelect = document.getElementById('convert-select');
      const qualityRow = document.getElementById('quality-row');
      const qualityInput = document.getElementById('quality');
      const qualityLabel = document.getElementById('quality-label');

      mediaFile.addEventListener('change', () => {
        const isImage = mediaFile.files[0]?.type.startsWith('image/');
        convertRow.style.display = isImage ? 'block' : 'none';
        if (!isImage) convertSelect.value = 'leave';
      });

      convertSelect.addEventListener('change', () => {
        qualityRow.style.display = convertSelect.value === 'jpg' ? 'block' : 'none';
      });

      qualityInput.addEventListener('input', () => {
        qualityLabel.textContent = qualityInput.value;
      });
    </script>

    <hr>

    <% if (files === null) { %>
      <p>Could not read media directory. Set <code>MEDIA_DIRECTORY</code> in .env.</p>
    <% } else if (files.length === 0) { %>
      <p>no files yet.</p>
    <% } else { %>
      <ul class="media-list">
        <% for (const file of files) { %>
          <li class="media-item">
            <% if (file.isImage) { %>
              <img src="<%= file.url %>" alt="" class="media-thumb">
            <% } else { %>
              <div class="media-icon">[<%= file.ext %>]</div>
            <% } %>
            <div class="media-info">
              <strong><%= file.name %></strong><br>
              <input type="text" readonly value="<%= file.url %>" onclick="this.select()" title="URL"><br>
              <% if (file.isImage) { %>
                <input type="text" readonly value="![<%= file.name %>](<%= file.url %>)" onclick="this.select()" title="Markdown"><br>
              <% } %>
              <form method="POST" action="/admin/media/delete/<%= encodeURIComponent(file.name) %>">
                <button type="submit" class="btn-danger" onclick="return confirm('Delete <%= file.name %>?')">delete</button>
              </form>
            </div>
          </li>
        <% } %>
      </ul>
    <% } %>
  </main>
</body>
</html>
